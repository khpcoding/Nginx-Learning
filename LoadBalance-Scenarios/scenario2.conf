# Define an upstream group named 'backends' with three backend servers
upstream backends {
    ip_hash;  # Use the IP hash algorithm for session persistence
    server 127.0.0.1:8080;  # First backend server
    server 127.0.0.1:8081;  # Second backend server
    server 127.0.0.1:8082;  # Third backend server
}

# Define the main server block for load balancing
server {
    server_name 127.0.0.1;  # Server name (hostname or IP address)
    listen 85;  # Listen on port 85

    location / {
        proxy_pass http://backends;  # Proxy requests to the 'backends' upstream group
        proxy_set_header Host $host;  # Preserve the original Host header
        proxy_set_header X-Real-IP $remote_addr;  # Preserve the client IP address
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Forward the client IP address in a chain of proxy servers
        proxy_set_header X-Forwarded-Proto $scheme;  # Preserve the original scheme (http or https)
    }
}

# Define the server block for the first backend
server {
    server_name 127.0.0.1;  # Server name (hostname or IP address)
    listen 8080;  # Listen on port 8080
    root /home/blog/one;  # Root directory for serving files
}

# Define the server block for the second backend
server {
    server_name 127.0.0.1;  # Server name (hostname or IP address)
    listen 8081;  # Listen on port 8081
    root /home/blog/two;  # Root directory for serving files
}

# Define the server block for the third backend
server {
    server_name 127.0.0.1;  # Server name (hostname or IP address)
    listen 8082;  # Listen on port 8082
    root /home/blog/three;  # Root directory for serving files
}
